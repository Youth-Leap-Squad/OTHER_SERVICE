<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.eat.today.event.worldcup.query.mapper.WorldcupMapper">

    <!-- worldcup 테이블 매핑 -->
    <resultMap id="worldcup" type="com.eat.today.event.worldcup.query.dto.WorldcupDTO">
<!--        <id property="worldcup_no" column="worldcuptable_worldcup_no"/>-->
        <result property="worldcup_start_date" column="worldcuptable_worldcup_start_date"/>
        <result property="worldcup_finish_date" column="worldcuptable_worldcup_finish_date"/>
    </resultMap>

    <!-- eventfood 테이블 매핑 -->
    <resultMap id="eventfood" type="com.eat.today.event.worldcup.query.dto.EventfoodDTO">
        <result property="worldcup_winning_food" column="worldcupeventfood_worldcup_winning_food"/>
        <result property="num_of_wins" column="worldcupeventfood_num_of_wins"/>
    </resultMap>

    <!-- 최종 결과 매핑 -->
    <resultMap id="WorldcupResultMap" type="com.eat.today.event.worldcup.query.dto.SelectWorldcupDTO">
        <association property="worldcuptable" resultMap="worldcup"/>
        <association property="worldcupeventfood" resultMap="eventfood"/>
    </resultMap>

    <!-- 주간 월드컵 게임 랭킹 조회 -->
    <select id="selectWorldcup" parameterType="java.lang.String" resultMap="WorldcupResultMap">
        WITH week_cte AS (
            SELECT
                wc.worldcup_start_date,
                wc.worldcup_finish_date,
                ROW_NUMBER() OVER (ORDER BY wc.worldcup_start_date) AS week_no
            FROM worldcup wc
            GROUP BY wc.worldcup_start_date, wc.worldcup_finish_date
        )
        SELECT
<!--            wc.worldcup_no                 AS worldcuptable_worldcup_no,-->
            w.worldcup_start_date          AS worldcuptable_worldcup_start_date,
            w.worldcup_finish_date         AS worldcuptable_worldcup_finish_date,
            ef.worldcup_winning_food       AS worldcupeventfood_worldcup_winning_food,
            ef.num_of_wins                 AS worldcupeventfood_num_of_wins
        FROM week_cte w
        JOIN worldcup wc ON wc.worldcup_start_date = w.worldcup_start_date
                        AND wc.worldcup_finish_date = w.worldcup_finish_date
        JOIN Individual_world_cup_food iwf ON wc.worldcup_no = iwf.worldcup_no
        JOIN eventfood ef ON iwf.food_no = ef.food_no
        WHERE ef.num_of_wins IN (
            SELECT ef2.num_of_wins
            FROM Individual_world_cup_food iwf2
            JOIN eventfood ef2 ON iwf2.food_no = ef2.food_no
            WHERE iwf2.worldcup_no = wc.worldcup_no
        )
          AND w.week_no = #{weekNo}
        ORDER BY ef.num_of_wins DESC;
    </select>
</mapper>